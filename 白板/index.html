<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™½æ¿</title>
  <!-- è±†åŒ…ç”Ÿæˆ2026.1.2 å«è±†åŒ…æ”¹å¥½å¤šæ¬¡è¿˜æ˜¯æœ‰ä¸€ä¸ªbugï¼šç¬”ç”»å¤ªå¿«åˆ°è¾¹ç¼˜ä¼šç©ºä¸€æ®µã€å½¢çŠ¶åˆ°è¾¹ç¼˜ä¼šå¡ä½å†éšä¾¿ç”»ä¸€ä¸‹ï¼Œå¡åœ¨çš„å½¢çŠ¶ä¼šæ¶ˆå¤±ã€æ©¡çš®æ“¦åˆ’å‡ºè¾¹ç¼˜åä¼šæ“¦ä¸æ‰ è¦é‡æ–°åœ¨é‡Œé¢æ“¦-->
  <style>
    /* å…¨å±€æ ·å¼é‡ç½® */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
    }

    body, html {
      height: 100%;
      overflow: hidden;
    }

    /* å®¹å™¨å¸ƒå±€ï¼šå·¥å…·æ +ç”»å¸ƒ */
    .whiteboard-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* å·¥å…·æ æ ·å¼ */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px; /* æŒ‰é’®é—´è·10px */
      padding: 12px 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      flex-wrap: wrap;
      row-gap: 8px;
    }

    /* å·¥å…·æŒ‰é’®æ ·å¼ - æ–°å¢å›¾æ ‡å®¹å™¨ */
    .tool-btn {
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px; /* å›¾æ ‡ä¸æ–‡å­—é—´è· */
    }

    .tool-btn:hover {
      background: #e9ecef; /* hoverå˜è‰² */
    }

    .tool-btn.active {
      background: #28a745; /* é€‰ä¸­æ€ç»¿è‰² */
      color: white;
      border-color: #28a745;
    }

    /* å·¥å…·å›¾æ ‡æ ·å¼ */
    .tool-icon {
      font-size: 16px;
      display: inline-block;
      width: 18px;
      text-align: center;
    }

    /* æ ·å¼æ§åˆ¶åŒºåŸŸ */
    .style-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .style-control label {
      font-size: 14px;
      color: #495057;
    }

    .style-control input[type="color"] {
      width: 36px;
      height: 36px;
      border: none;
      cursor: pointer;
      padding: 0;
      background: transparent;
    }

    .style-control input[type="range"] {
      width: 120px;
      cursor: pointer;
    }

    .style-control .value-display {
      width: 40px;
      text-align: center;
      font-size: 14px;
      color: #495057;
    }

    /* ç¬”ç”»å¤§å°é¢„è§ˆ */
    .brush-preview {
      width: 60px;
      height: 30px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brush-preview-dot {
      background: #000;
      border-radius: 50%;
      /* åŠ¨æ€è°ƒæ•´å¤§å° */
    }

    /* æœ€è¿‘é¢œè‰²å±•ç¤º */
    .recent-colors {
      display: flex;
      gap: 4px;
    }

    .recent-color-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      border: 1px solid #ccc;
    }

    /* ç”»å¸ƒå®¹å™¨ï¼ˆç”¨äºç¼©æ”¾ï¼‰ */
    .canvas-wrapper {
      flex: 1;
      position: relative;
      overflow: auto;
      background: #eccdcd;
      cursor: none; /* éšè—åŸç”Ÿå…‰æ ‡ */
    }

    /* æ–°å¢ï¼šè‡ªå®šä¹‰ç”»ç¬”å…‰æ ‡ */
    .brush-cursor {
      position: absolute;
      border-radius: 50%;
      pointer-events: none; /* ä¸æ‹¦æˆªé¼ æ ‡äº‹ä»¶ */
      z-index: 9999;
      display: none; /* é»˜è®¤éšè— */
      transform: translate(-50%, -50%); /* å…‰æ ‡ä¸­å¿ƒå¯¹é½é¼ æ ‡ */
    }

    /* ä¸»ç”»å¸ƒ+ä¸´æ—¶ç”»å¸ƒæ ·å¼ */
    #mainCanvas, #tempCanvas {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0; /* ç¼©æ”¾åŸç‚¹ä¸ºå·¦ä¸Šè§’ */
    }

    #tempCanvas {
      pointer-events: none; /* ä¸´æ—¶ç”»å¸ƒä¸æ‹¦æˆªé¼ æ ‡äº‹ä»¶ */
      z-index: 1;
    }

    #mainCanvas {
      z-index: 0;
      background: white;
    }

    /* æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div class="whiteboard-container">
  <!-- å·¥å…·æ  -->
  <div class="toolbar">
    <!-- ç»˜å›¾å·¥å…·æŒ‰é’® - å›¾æ ‡ -->
    <button class="tool-btn active" data-tool="pencil">
      <span class="tool-icon">âœï¸</span>é“…ç¬”
    </button>
    <button class="tool-btn" data-tool="line">
      <span class="tool-icon">ğŸ“</span>ç›´çº¿
    </button>
    <button class="tool-btn" data-tool="rect">
      <span class="tool-icon">ğŸŸ¦</span>çŸ©å½¢
    </button>
    <button class="tool-btn" data-tool="circle">
      <span class="tool-icon">ğŸŸ </span>åœ†å½¢
    </button>
    <button class="tool-btn" data-tool="ellipse">
      <span class="tool-icon">ğŸŸª</span>æ¤­åœ†
    </button>
    <button class="tool-btn" data-tool="eraser">
      <span class="tool-icon">ğŸ§½</span>æ©¡çš®æ“¦
    </button>

    <!-- é¢œè‰²æ§åˆ¶ -->
    <div class="style-control">
      <label>é¢œè‰²ï¼š</label>
      <input type="color" id="colorPicker" value="#000000">
      <div class="recent-colors" id="recentColors"></div>
    </div>

    <!-- ç²—ç»†æ§åˆ¶ - ç¬”ç”»é¢„è§ˆ -->
    <div class="style-control">
      <label>ç²—ç»†ï¼š</label>
      <input type="range" id="lineWidth" min="1" max="30" value="5">
      <span class="value-display" id="lineWidthValue">5px</span>
      <!-- ç¬”ç”»å¤§å°é¢„è§ˆ -->
      <div class="brush-preview">
        <div class="brush-preview-dot" id="brushPreviewDot"></div>
      </div>
    </div>

    <!-- é€æ˜åº¦æ§åˆ¶ -->
    <div class="style-control">
      <label>é€æ˜åº¦ï¼š</label>
      <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="1">
      <span class="value-display" id="opacityValue">1.0</span>
    </div>

    <!-- åœ†è§’çŸ©å½¢æ§åˆ¶ï¼ˆä»…çŸ©å½¢å·¥å…·æ˜¾ç¤ºï¼‰ -->
    <div class="style-control" id="rectRadiusControl" style="display: none;">
      <label>åœ†è§’ï¼š</label>
      <input type="range" id="rectRadius" min="0" max="50" value="0">
      <span class="value-display" id="rectRadiusValue">0px</span>
    </div>

    <!-- ç¼–è¾‘åŠŸèƒ½æŒ‰é’® - å›¾æ ‡ -->
    <button class="tool-btn" id="undoBtn">
      <span class="tool-icon">â†©ï¸</span>æ’¤é”€
    </button>
    <button class="tool-btn" id="redoBtn">
      <span class="tool-icon">â†ªï¸</span>é‡åš
    </button>
    <button class="tool-btn" id="clearBtn">
      <span class="tool-icon">ğŸ—‘ï¸</span>æ¸…ç©ºç”»å¸ƒ
    </button>
    <button class="tool-btn" id="saveBtn">
      <span class="tool-icon">ğŸ’¾</span>ä¿å­˜å›¾ç‰‡
    </button>
  </div>

  <!-- ç”»å¸ƒå®¹å™¨ -->
  <div class="canvas-wrapper" id="canvasWrapper">
    <!-- æ–°å¢ï¼šè‡ªå®šä¹‰ç”»ç¬”å…‰æ ‡ -->
    <div class="brush-cursor" id="brushCursor"></div>
    <canvas id="mainCanvas"></canvas>
    <canvas id="tempCanvas"></canvas>
  </div>
</div>

<script>
  // ========== å…¨å±€çŠ¶æ€ç®¡ç†ï¼ˆç»Ÿä¸€ç»´æŠ¤ç™½æ¿çŠ¶æ€ï¼‰ ==========
  const state = {
    currentTool: 'pencil',          // å½“å‰é€‰ä¸­å·¥å…·
    isDrawing: false,               // æ˜¯å¦æ­£åœ¨ç»˜åˆ¶
    startPos: {x: 0, y: 0},       // ç»˜åˆ¶èµ·å§‹åæ ‡
    currentPos: {x: 0, y: 0},     // ç»˜åˆ¶å½“å‰åæ ‡
    scale: 1,                       // ç”»å¸ƒç¼©æ”¾æ¯”ä¾‹
    // ç”»ç¬”æ ·å¼é…ç½®
    brush: {
      color: '#000000',
      lineWidth: 5,
      opacity: 1,
      rectRadius: 0
    },
    // æœ€è¿‘ä½¿ç”¨çš„é¢œè‰²ï¼ˆæœ€å¤š5ä¸ªï¼‰
    recentColors: [],
    // å†å²è®°å½•ç›¸å…³
    history: [],                    // ç”»å¸ƒçŠ¶æ€å†å²ï¼ˆå­˜å‚¨dataURLï¼‰
    currentStep: -1                 // å½“å‰å†å²æ­¥éª¤
  };

  // ========== DOMå…ƒç´ è·å– ==========
  const elements = {
    mainCanvas: document.getElementById('mainCanvas'),
    tempCanvas: document.getElementById('tempCanvas'),
    canvasWrapper: document.getElementById('canvasWrapper'),
    brushCursor: document.getElementById('brushCursor'), // æ–°å¢ï¼šè‡ªå®šä¹‰å…‰æ ‡
    toolBtns: document.querySelectorAll('.tool-btn[data-tool]'),
    colorPicker: document.getElementById('colorPicker'),
    recentColors: document.getElementById('recentColors'),
    lineWidth: document.getElementById('lineWidth'),
    lineWidthValue: document.getElementById('lineWidthValue'),
    brushPreviewDot: document.getElementById('brushPreviewDot'), // ç¬”ç”»é¢„è§ˆ
    opacity: document.getElementById('opacity'),
    opacityValue: document.getElementById('opacityValue'),
    rectRadiusControl: document.getElementById('rectRadiusControl'),
    rectRadius: document.getElementById('rectRadius'),
    rectRadiusValue: document.getElementById('rectRadiusValue'),
    undoBtn: document.getElementById('undoBtn'),
    redoBtn: document.getElementById('redoBtn'),
    clearBtn: document.getElementById('clearBtn'),
    saveBtn: document.getElementById('saveBtn')
  };

  // è·å–2Dä¸Šä¸‹æ–‡
  const mainCtx = elements.mainCanvas.getContext('2d');
  const tempCtx = elements.tempCanvas.getContext('2d');

  // ========== æ¨¡å—1ï¼šå·¥å…·åˆå§‹åŒ–ï¼ˆinitToolsï¼‰ ==========
  /**
   * åˆå§‹åŒ–æ‰€æœ‰å·¥å…·å’Œäº‹ä»¶ç›‘å¬
   * åŠŸèƒ½ï¼šç»‘å®šå·¥å…·åˆ‡æ¢ã€æ ·å¼è°ƒæ•´ã€ç¼–è¾‘æŒ‰é’®ç­‰äº‹ä»¶
   */
  function initTools() {
    // 1. å·¥å…·æŒ‰é’®åˆ‡æ¢äº‹ä»¶
    elements.toolBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®é€‰ä¸­æ€
        elements.toolBtns.forEach(b => b.classList.remove('active'));
        // æ·»åŠ å½“å‰æŒ‰é’®é€‰ä¸­æ€
        btn.classList.add('active');
        // æ›´æ–°å½“å‰å·¥å…·
        state.currentTool = btn.dataset.tool;
        // æ˜¾ç¤º/éšè—çŸ©å½¢åœ†è§’æ§åˆ¶
        elements.rectRadiusControl.style.display = state.currentTool === 'rect' ? 'flex' : 'none';
        // æ›´æ–°ç¬”ç”»é¢„è§ˆå’Œå…‰æ ‡æ ·å¼
        updateBrushPreview();
        updateBrushCursorStyle();
      });
    });

    // 2. é¢œè‰²æ‹¾å–å™¨äº‹ä»¶
    elements.colorPicker.addEventListener('input', (e) => {
      updateBrushStyle('color', e.target.value);
      addRecentColor(e.target.value); // æ·»åŠ åˆ°æœ€è¿‘é¢œè‰²
      updateBrushPreview(); // æ›´æ–°é¢„è§ˆ
      updateBrushCursorStyle(); // æ–°å¢ï¼šæ›´æ–°å…‰æ ‡æ ·å¼
    });

    // 3. ç”»ç¬”ç²—ç»†è°ƒæ•´äº‹ä»¶
    elements.lineWidth.addEventListener('input', (e) => {
      const value = Number(e.target.value);
      updateBrushStyle('lineWidth', value);
      elements.lineWidthValue.textContent = `${value}px`;
      updateBrushPreview(); // æ›´æ–°é¢„è§ˆå¤§å°
      updateBrushCursorStyle(); // æ–°å¢ï¼šæ›´æ–°å…‰æ ‡å¤§å°
    });

    // 4. é€æ˜åº¦è°ƒæ•´äº‹ä»¶
    elements.opacity.addEventListener('input', (e) => {
      const value = Number(e.target.value);
      updateBrushStyle('opacity', value);
      elements.opacityValue.textContent = value.toFixed(1);
      updateBrushPreview(); // æ›´æ–°é¢„è§ˆé€æ˜åº¦
      updateBrushCursorStyle(); // æ–°å¢ï¼šæ›´æ–°å…‰æ ‡é€æ˜åº¦
    });

    // 5. çŸ©å½¢åœ†è§’è°ƒæ•´äº‹ä»¶
    elements.rectRadius.addEventListener('input', (e) => {
      const value = Number(e.target.value);
      updateBrushStyle('rectRadius', value);
      elements.rectRadiusValue.textContent = `${value}px`;
    });

    // 6. ç¼–è¾‘æŒ‰é’®äº‹ä»¶ç»‘å®š
    elements.undoBtn.addEventListener('click', undo);
    elements.redoBtn.addEventListener('click', redo);
    elements.clearBtn.addEventListener('click', clearCanvas);
    elements.saveBtn.addEventListener('click', saveImage);

    // 7. åˆå§‹åŒ–æœ€è¿‘é¢œè‰²ï¼ˆé»˜è®¤æ·»åŠ é»‘è‰²ï¼‰
    addRecentColor('#000000');

    // 8. ç»‘å®šç”»å¸ƒç»˜åˆ¶äº‹ä»¶
    bindCanvasEvents();

    // 9. ç»‘å®šæ»šè½®ç¼©æ”¾äº‹ä»¶
    bindScaleEvent();

    // 10. çª—å£å¤§å°è°ƒæ•´äº‹ä»¶
    window.addEventListener('resize', resizeCanvas);

    // æ–°å¢ï¼šç»‘å®šå…‰æ ‡ç›¸å…³äº‹ä»¶
    bindCursorEvents();

    // åˆå§‹åŒ–ç”»å¸ƒå¤§å°
    resizeCanvas();

    // åˆå§‹åŒ–å†å²è®°å½•ï¼ˆä¿å­˜ç©ºç™½ç”»å¸ƒï¼‰
    saveToHistory();

    // åˆå§‹åŒ–ç¬”ç”»é¢„è§ˆå’Œå…‰æ ‡
    updateBrushPreview();
    updateBrushCursorStyle();
  }

  // ========== æ¨¡å—2ï¼šç»˜åˆ¶é€»è¾‘ï¼ˆdrawHandlersï¼‰ ==========
  /**
   * ç»‘å®šç”»å¸ƒé¼ æ ‡/è§¦æ‘¸äº‹ä»¶ï¼Œå¤„ç†ç»˜åˆ¶é€»è¾‘
   */
  function bindCanvasEvents() {
    // é¼ æ ‡æŒ‰ä¸‹ï¼šå¼€å§‹ç»˜åˆ¶
    elements.mainCanvas.addEventListener('mousedown', (e) => {
      state.isDrawing = true;
      // è·å–ç¼©æ”¾åçš„å®é™…åæ ‡
      state.startPos = getScaledCanvasPos(e);
      state.currentPos = {...state.startPos};
      // æ¸…ç©ºä¸´æ—¶ç”»å¸ƒ
      clearTempCanvas();

      // é“…ç¬”/æ©¡çš®æ“¦åˆå§‹åŒ–ç»˜åˆ¶è·¯å¾„
      if (['pencil', 'eraser'].includes(state.currentTool)) {
        mainCtx.beginPath();
        mainCtx.moveTo(state.startPos.x, state.startPos.y);

        // æ©¡çš®æ“¦é¢å¤–åˆå§‹åŒ–åˆæˆæ¨¡å¼
        if (state.currentTool === 'eraser') {
          mainCtx.save(); // ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡çŠ¶æ€
          mainCtx.globalCompositeOperation = 'destination-out'; // é€æ˜æ“¦é™¤æ¨¡å¼
          mainCtx.lineCap = 'round'; // çº¿æ¡ç«¯ç‚¹åœ†æ¶¦
          mainCtx.lineJoin = 'round'; // çº¿æ¡æ‹è§’åœ†æ¶¦
          mainCtx.lineWidth = state.brush.lineWidth; // æ©¡çš®æ“¦ç²—ç»†
        }
      }
    });

    // é¼ æ ‡ç§»åŠ¨ï¼šç»˜åˆ¶è¿‡ç¨‹
    elements.mainCanvas.addEventListener('mousemove', (e) => {
      if (!state.isDrawing) return;
      state.currentPos = getScaledCanvasPos(e);

      switch (state.currentTool) {
        case 'pencil':
          drawPencil();
          break;
        case 'eraser':
          drawEraser(); // ä¿®å¤ï¼šè¿ç»­è·¯å¾„æ“¦é™¤
          break;
        case 'line':
        case 'rect':
        case 'circle':
        case 'ellipse':
          // å½¢çŠ¶å·¥å…·åœ¨ä¸´æ—¶ç”»å¸ƒé¢„è§ˆ
          drawShapeOnTempCanvas();
          break;
      }
    });

    // é¼ æ ‡æŠ¬èµ·ï¼šç»“æŸç»˜åˆ¶
    elements.mainCanvas.addEventListener('mouseup', () => {
      if (!state.isDrawing) return;
      state.isDrawing = false;

      // æ©¡çš®æ“¦æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€
      if (state.currentTool === 'eraser') {
        mainCtx.restore(); // æ¢å¤é»˜è®¤åˆæˆæ¨¡å¼
      }

      // å½¢çŠ¶å·¥å…·ï¼šå°†ä¸´æ—¶ç”»å¸ƒå†…å®¹ç»˜åˆ¶åˆ°ä¸»ç”»å¸ƒ
      if (['line', 'rect', 'circle', 'ellipse'].includes(state.currentTool)) {
        drawShapeOnMainCanvas();
        clearTempCanvas();
      }

      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
      saveToHistory();
    });

    // é¼ æ ‡ç§»å‡ºç”»å¸ƒï¼šç»“æŸç»˜åˆ¶
    elements.mainCanvas.addEventListener('mouseout', () => {
      if (state.isDrawing && state.currentTool === 'eraser') {
        mainCtx.restore(); // æ¢å¤ä¸Šä¸‹æ–‡
      }
      state.isDrawing = false;
    });
  }

  /**
   * ç»˜åˆ¶é“…ç¬”ï¼ˆæµç•…çº¿æ¡ï¼Œç«¯ç‚¹/æ‹è§’åœ†æ¶¦ï¼‰
   */
  function drawPencil() {
    setBrushStyle(mainCtx);
    mainCtx.lineTo(state.currentPos.x, state.currentPos.y);
    mainCtx.stroke();
  }

  /**
   * ä¿®å¤ï¼šæ©¡çš®æ“¦æ”¹ä¸ºè¿ç»­è·¯å¾„æ“¦é™¤ï¼ˆå½»åº•è§£å†³æ®‹ç•™é—®é¢˜ï¼‰
   */
  function drawEraser() {
    // è¿ç»­ç»˜åˆ¶è·¯å¾„ï¼Œå’Œé“…ç¬”é€»è¾‘ä¸€è‡´ï¼Œç¡®ä¿æ— é—´éš™
    mainCtx.lineTo(state.currentPos.x, state.currentPos.y);
    mainCtx.stroke(); // ç»˜åˆ¶è¿ç»­çš„æ“¦é™¤è·¯å¾„

    // å¯é€‰ä¼˜åŒ–ï¼šåœ¨è·¯å¾„ç«¯ç‚¹ç»˜åˆ¶åœ†å½¢ï¼Œç¡®ä¿è¾¹ç¼˜æ— æ­»è§’
    mainCtx.beginPath();
    mainCtx.arc(state.currentPos.x, state.currentPos.y, state.brush.lineWidth / 2, 0, Math.PI * 2);
    mainCtx.fill();
    mainCtx.beginPath();
    mainCtx.moveTo(state.currentPos.x, state.currentPos.y);
  }

  /**
   * åœ¨ä¸´æ—¶ç”»å¸ƒç»˜åˆ¶å½¢çŠ¶ï¼ˆé¢„è§ˆæ•ˆæœï¼Œä¸ä¿®æ”¹ä¸»ç”»å¸ƒï¼‰
   */
  function drawShapeOnTempCanvas() {
    clearTempCanvas();
    setBrushStyle(tempCtx);
    drawShape(tempCtx);
  }

  /**
   * åœ¨ä¸»ç”»å¸ƒç»˜åˆ¶å½¢çŠ¶ï¼ˆå®Œæˆç»˜åˆ¶ï¼‰
   */
  function drawShapeOnMainCanvas() {
    setBrushStyle(mainCtx);
    drawShape(mainCtx);
  }

  /**
   * ç»˜åˆ¶æŒ‡å®šå½¢çŠ¶ï¼ˆç›´çº¿/çŸ©å½¢/åœ†å½¢/æ¤­åœ†ï¼‰- ä¿®å¤roundRectå…¼å®¹é—®é¢˜
   * @param {CanvasRenderingContext2D} ctx - ç»˜åˆ¶ä¸Šä¸‹æ–‡
   */
  function drawShape(ctx) {
    const {startPos, currentPos, brush} = state;
    const x = startPos.x;
    const y = startPos.y;
    const width = currentPos.x - startPos.x;
    const height = currentPos.y - startPos.y;

    ctx.beginPath();
    switch (state.currentTool) {
      case 'line':
        // ç›´çº¿
        ctx.moveTo(x, y);
        ctx.lineTo(currentPos.x, currentPos.y);
        break;
      case 'rect':
        // ä¿®å¤ï¼šæ‰‹åŠ¨å®ç°åœ†è§’çŸ©å½¢ï¼ˆå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼‰
        drawRoundedRect(ctx, x, y, width, height, brush.rectRadius);
        break;
      case 'circle':
        // åœ†å½¢ï¼ˆåŠå¾„ä¸ºèµ·ç‚¹åˆ°å½“å‰ç‚¹çš„è·ç¦»ï¼‰
        const radius = Math.sqrt(width * width + height * height);
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        break;
      case 'ellipse':
        // æ¤­åœ†ï¼ˆé•¿åŠè½´/çŸ­åŠè½´ä¸ºå®½é«˜çš„ç»å¯¹å€¼ï¼‰
        const rx = Math.abs(width);
        const ry = Math.abs(height);
        ctx.ellipse(x, y, rx, ry, 0, 0, Math.PI * 2);
        break;
    }
    ctx.stroke();
  }

  /**
   * æ‰‹åŠ¨ç»˜åˆ¶åœ†è§’çŸ©å½¢ï¼ˆæ›¿ä»£ctx.roundRectï¼Œå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼‰
   * @param {CanvasRenderingContext2D} ctx - ç»˜åˆ¶ä¸Šä¸‹æ–‡
   * @param {number} x - çŸ©å½¢èµ·å§‹Xåæ ‡
   * @param {number} y - çŸ©å½¢èµ·å§‹Yåæ ‡
   * @param {number} width - çŸ©å½¢å®½åº¦ï¼ˆå¯æ­£å¯è´Ÿï¼‰
   * @param {number} height - çŸ©å½¢é«˜åº¦ï¼ˆå¯æ­£å¯è´Ÿï¼‰
   * @param {number} radius - åœ†è§’åŠå¾„
   */
  function drawRoundedRect(ctx, x, y, width, height, radius) {
    // å¤„ç†å®½é«˜ä¸ºè´Ÿæ•°çš„æƒ…å†µï¼ˆä»å³ä¸‹å‘å·¦ä¸Šç»˜åˆ¶ï¼‰
    const xStart = width < 0 ? x + width : x;
    const yStart = height < 0 ? y + height : y;
    const w = Math.abs(width);
    const h = Math.abs(height);
    const r = Math.min(radius, Math.min(w / 2, h / 2)); // é™åˆ¶åœ†è§’åŠå¾„ä¸è¶…è¿‡å®½é«˜çš„ä¸€åŠ

    ctx.moveTo(xStart + r, yStart);
    ctx.lineTo(xStart + w - r, yStart);
    ctx.arcTo(xStart + w, yStart, xStart + w, yStart + r, r);
    ctx.lineTo(xStart + w, yStart + h - r);
    ctx.arcTo(xStart + w, yStart + h, xStart + w - r, yStart + h, r);
    ctx.lineTo(xStart + r, yStart + h);
    ctx.arcTo(xStart, yStart + h, xStart, yStart + h - r, r);
    ctx.lineTo(xStart, yStart + r);
    ctx.arcTo(xStart, yStart, xStart + r, yStart, r);
    ctx.closePath();
  }

  /**
   * è®¾ç½®ç”»ç¬”æ ·å¼
   * @param {CanvasRenderingContext2D} ctx - ç»˜åˆ¶ä¸Šä¸‹æ–‡
   */
  function setBrushStyle(ctx) {
    // æ©¡çš®æ“¦ç‰¹æ®Šå¤„ç†ï¼šé¢œè‰²ä¸ºç™½è‰²ï¼ˆé¢„è§ˆç”¨ï¼‰ï¼Œç»˜åˆ¶æ—¶ç”¨åˆæˆæ¨¡å¼
    const color = state.currentTool === 'eraser' ? '#ffffff' : state.brush.color;
    ctx.strokeStyle = color;
    ctx.lineWidth = state.brush.lineWidth;
    ctx.globalAlpha = state.brush.opacity;
    ctx.lineCap = 'round'; // çº¿æ¡ç«¯ç‚¹åœ†æ¶¦
    ctx.lineJoin = 'round'; // çº¿æ¡æ‹è§’åœ†æ¶¦
    ctx.fillStyle = color; // å¤‡ç”¨ï¼ˆå¦‚éœ€å¡«å……å½¢çŠ¶ï¼‰
  }

  // ========== æ¨¡å—3ï¼šå†å²è®°å½•ç®¡ç†ï¼ˆhistoryManagerï¼‰ ==========
  /**
   * ä¿å­˜å½“å‰ç”»å¸ƒçŠ¶æ€åˆ°å†å²è®°å½•
   * é€»è¾‘ï¼šæ’¤é”€åç»˜åˆ¶æ—¶ï¼Œæ¸…ç©ºåç»­å†å²ï¼›ä»…ä¿å­˜æœ€æ–°çŠ¶æ€
   */
  function saveToHistory() {
    // æ’¤é”€åç»˜åˆ¶ï¼Œæ¸…ç©ºåç»­å†å²ï¼ˆé¿å…é‡åšå†²çªï¼‰
    if (state.currentStep < state.history.length - 1) {
      state.history = state.history.slice(0, state.currentStep + 1);
    }
    // å°†ç”»å¸ƒå†…å®¹è½¬ä¸ºbase64ä¿å­˜ï¼ˆæ”¯æŒæ— é™æ¬¡æ’¤é”€ï¼Œç›´åˆ°åˆå§‹çŠ¶æ€ï¼‰
    state.history.push(elements.mainCanvas.toDataURL('image/png'));
    state.currentStep = state.history.length - 1;
    // æ›´æ–°æ’¤é”€/é‡åšæŒ‰é’®çŠ¶æ€
    updateHistoryBtnStatus();
  }

  /**
   * æ’¤é”€æ“ä½œï¼šæ¢å¤ä¸Šä¸€æ­¥ç”»å¸ƒçŠ¶æ€
   */
  function undo() {
    if (state.currentStep <= 0) return;
    state.currentStep--;
    restoreHistory();
    updateHistoryBtnStatus();
  }

  /**
   * é‡åšæ“ä½œï¼šæ¢å¤ä¸‹ä¸€æ­¥ç”»å¸ƒçŠ¶æ€
   */
  function redo() {
    if (state.currentStep >= state.history.length - 1) return;
    state.currentStep++;
    restoreHistory();
    updateHistoryBtnStatus();
  }

  /**
   * æ¢å¤æŒ‡å®šæ­¥éª¤çš„ç”»å¸ƒçŠ¶æ€
   */
  function restoreHistory() {
    const img = new Image();
    img.src = state.history[state.currentStep];
    img.onload = () => {
      // æ¸…ç©ºä¸»ç”»å¸ƒå¹¶æ¢å¤å†å²çŠ¶æ€
      mainCtx.clearRect(0, 0, elements.mainCanvas.width, elements.mainCanvas.height);
      mainCtx.drawImage(img, 0, 0);
    };
  }

  /**
   * æ›´æ–°æ’¤é”€/é‡åšæŒ‰é’®ç¦ç”¨çŠ¶æ€
   */
  function updateHistoryBtnStatus() {
    elements.undoBtn.disabled = state.currentStep <= 0;
    elements.redoBtn.disabled = state.currentStep >= state.history.length - 1;
  }

  // ========== æ¨¡å—4ï¼šå·¥å…·å‡½æ•°ï¼ˆutilsï¼‰ ==========
  /**
   * æ›´æ–°ç”»ç¬”æ ·å¼
   * @param {string} key - æ ·å¼å±æ€§åï¼ˆcolor/lineWidth/opacity/rectRadiusï¼‰
   * @param {any} value - æ ·å¼å€¼
   */
  function updateBrushStyle(key, value) {
    state.brush[key] = value;
    // åŒæ­¥é¢œè‰²æ‹¾å–å™¨å€¼ï¼ˆä»…é¢œè‰²å±æ€§ï¼‰
    if (key === 'color') {
      elements.colorPicker.value = value;
    }
  }

  /**
   * æ›´æ–°ç¬”ç”»å¤§å°é¢„è§ˆ
   */
  function updateBrushPreview() {
    const previewDot = elements.brushPreviewDot;
    // è®¾ç½®é¢„è§ˆç‚¹å¤§å°ï¼ˆç­‰äºç”»ç¬”ç²—ç»†ï¼‰
    previewDot.style.width = `${state.brush.lineWidth}px`;
    previewDot.style.height = `${state.brush.lineWidth}px`;
    // è®¾ç½®é¢„è§ˆç‚¹é¢œè‰²ï¼ˆæ©¡çš®æ“¦æ˜¾ç¤ºç°è‰²è¾¹æ¡†ï¼Œç™½è‰²å¡«å……ï¼‰
    if (state.currentTool === 'eraser') {
      previewDot.style.backgroundColor = '#ffffff';
      previewDot.style.border = `1px solid #666666`;
    } else {
      previewDot.style.backgroundColor = state.brush.color;
      previewDot.style.border = 'none';
    }
    // è®¾ç½®é€æ˜åº¦
    previewDot.style.opacity = state.brush.opacity;
  }

  /**
   * æ–°å¢ï¼šæ›´æ–°è‡ªå®šä¹‰ç”»ç¬”å…‰æ ‡æ ·å¼
   */
  function updateBrushCursorStyle() {
    const cursor = elements.brushCursor;
    const lineWidth = state.brush.lineWidth * state.scale; // é€‚é…ç”»å¸ƒç¼©æ”¾

    // è®¾ç½®å…‰æ ‡å¤§å°ï¼ˆåŒ¹é…ç”»ç¬”ç²—ç»†ï¼Œé€‚é…ç¼©æ”¾ï¼‰
    cursor.style.width = `${lineWidth}px`;
    cursor.style.height = `${lineWidth}px`;

    // è®¾ç½®å…‰æ ‡æ ·å¼ï¼ˆåŒºåˆ†å·¥å…·ï¼‰
    if (state.currentTool === 'eraser') {
      // æ©¡çš®æ“¦ï¼šç™½è‰²å¡«å……+ç°è‰²è¾¹æ¡†
      cursor.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
      cursor.style.border = `1px solid #666666`;
      cursor.style.boxShadow = '0 0 2px rgba(0,0,0,0.3)';
    } else if (['line', 'rect', 'circle', 'ellipse'].includes(state.currentTool)) {
      // å½¢çŠ¶å·¥å…·ï¼šä»…è¾¹æ¡†ï¼Œæ— å¡«å……ï¼ˆæ¨¡æ‹Ÿç”»ç¬”è½®å»“ï¼‰
      cursor.style.backgroundColor = 'transparent';
      cursor.style.border = `1px solid ${state.brush.color}`;
      cursor.style.opacity = state.brush.opacity;
    } else {
      // é“…ç¬”ï¼šå®å¿ƒåœ†å½¢ï¼ŒåŒ¹é…ç”»ç¬”é¢œè‰²å’Œé€æ˜åº¦
      cursor.style.backgroundColor = state.brush.color;
      cursor.style.border = 'none';
      cursor.style.opacity = state.brush.opacity;
    }
  }

  /**
   * æ–°å¢ï¼šç»‘å®šå…‰æ ‡ç›¸å…³äº‹ä»¶ï¼ˆè·Ÿéš/æ˜¾ç¤º/éšè—ï¼‰
   */
  function bindCursorEvents() {
    const wrapper = elements.canvasWrapper;
    const cursor = elements.brushCursor;

    // é¼ æ ‡ç§»åŠ¨ï¼šå…‰æ ‡è·Ÿéš
    wrapper.addEventListener('mousemove', (e) => {
      // è®¾ç½®å…‰æ ‡ä½ç½®ï¼ˆç›¸å¯¹äºç”»å¸ƒå®¹å™¨ï¼‰
      cursor.style.left = `${e.clientX - wrapper.getBoundingClientRect().left}px`;
      cursor.style.top = `${e.clientY - wrapper.getBoundingClientRect().top}px`;
      // æ˜¾ç¤ºå…‰æ ‡
      cursor.style.display = 'block';
    });

    // é¼ æ ‡ç§»å‡ºç”»å¸ƒå®¹å™¨ï¼šéšè—å…‰æ ‡
    wrapper.addEventListener('mouseleave', () => {
      cursor.style.display = 'none';
    });

    // ç”»å¸ƒç¼©æ”¾æ—¶æ›´æ–°å…‰æ ‡æ ·å¼
    window.addEventListener('resize', updateBrushCursorStyle);
  }

  /**
   * æ·»åŠ æœ€è¿‘ä½¿ç”¨çš„é¢œè‰²ï¼ˆæœ€å¤š5ä¸ªï¼Œå»é‡ï¼‰
   * @param {string} color - é¢œè‰²å€¼ï¼ˆhexæ ¼å¼ï¼‰
   */
  function addRecentColor(color) {
    // å»é‡ï¼šå·²å­˜åœ¨åˆ™ç§»é™¤ï¼Œé‡æ–°æ·»åŠ åˆ°å¤´éƒ¨
    state.recentColors = state.recentColors.filter(c => c !== color);
    state.recentColors.unshift(color);
    // é™åˆ¶æœ€å¤š5ä¸ª
    if (state.recentColors.length > 5) {
      state.recentColors.pop();
    }
    // æ¸²æŸ“æœ€è¿‘é¢œè‰²æŒ‰é’®
    renderRecentColors();
  }

  /**
   * æ¸²æŸ“æœ€è¿‘ä½¿ç”¨çš„é¢œè‰²æŒ‰é’®
   */
  function renderRecentColors() {
    elements.recentColors.innerHTML = '';
    state.recentColors.forEach(color => {
      const btn = document.createElement('div');
      btn.className = 'recent-color-btn';
      btn.style.backgroundColor = color;
      btn.title = color;
      // ç‚¹å‡»æœ€è¿‘é¢œè‰²åˆ‡æ¢ç”»ç¬”é¢œè‰²
      btn.addEventListener('click', () => {
        updateBrushStyle('color', color);
        updateBrushPreview(); // æ›´æ–°é¢„è§ˆ
        updateBrushCursorStyle(); // æ–°å¢ï¼šæ›´æ–°å…‰æ ‡
      });
      elements.recentColors.appendChild(btn);
    });
  }

  /**
   * è·å–ç¼©æ”¾åçš„ç”»å¸ƒåæ ‡ï¼ˆé€‚é…æ»šè½®ç¼©æ”¾ï¼‰
   * @param {MouseEvent} e - é¼ æ ‡äº‹ä»¶
   * @returns {object} - ç¼©æ”¾åçš„{x, y}åæ ‡
   */
  function getScaledCanvasPos(e) {
    const rect = elements.mainCanvas.getBoundingClientRect();
    return {
      x: (e.clientX - rect.left) / state.scale,
      y: (e.clientY - rect.top) / state.scale
    };
  }

  /**
   * è°ƒæ•´ç”»å¸ƒå¤§å°ï¼ˆè‡ªé€‚åº”çª—å£ï¼‰
   * é€»è¾‘ï¼šç”»å¸ƒå¤§å°ç­‰äºå®¹å™¨å¤§å°ï¼Œç¼©æ”¾åä¿æŒç»˜åˆ¶å†…å®¹æ¯”ä¾‹
   */
  function resizeCanvas() {
    const wrapperRect = elements.canvasWrapper.getBoundingClientRect();
    // è®¾ç½®ä¸»ç”»å¸ƒ/ä¸´æ—¶ç”»å¸ƒå¤§å°
    elements.mainCanvas.width = wrapperRect.width;
    elements.mainCanvas.height = wrapperRect.height;
    elements.tempCanvas.width = wrapperRect.width;
    elements.tempCanvas.height = wrapperRect.height;
    // æ¢å¤å†å²çŠ¶æ€ï¼ˆé¿å…resizeåå†…å®¹ä¸¢å¤±ï¼‰
    restoreHistory();
    // åº”ç”¨ç¼©æ”¾æ¯”ä¾‹
    applyScale();
    // æ–°å¢ï¼šæ›´æ–°å…‰æ ‡æ ·å¼
    updateBrushCursorStyle();
  }

  /**
   * æ¸…ç©ºä¸´æ—¶ç”»å¸ƒ
   */
  function clearTempCanvas() {
    tempCtx.clearRect(0, 0, elements.tempCanvas.width, elements.tempCanvas.height);
  }

  /**
   * æ¸…ç©ºä¸»ç”»å¸ƒï¼ˆå¸¦ç¡®è®¤å¼¹çª—ï¼‰
   */
  function clearCanvas() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
      mainCtx.clearRect(0, 0, elements.mainCanvas.width, elements.mainCanvas.height);
      saveToHistory(); // ä¿å­˜æ¸…ç©ºåçš„çŠ¶æ€
    }
  }

  /**
   * ä¿å­˜ç”»å¸ƒä¸ºPNGå›¾ç‰‡ï¼ˆæ–‡ä»¶åå¸¦æ—¶é—´æˆ³ï¼‰
   */
  function saveImage() {
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const link = document.createElement('a');
    // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    link.download = `ç™½æ¿_${timestamp}.png`;
    // å¯¼å‡ºç”»å¸ƒä¸ºPNG
    link.href = elements.mainCanvas.toDataURL('image/png');
    // è§¦å‘ä¸‹è½½
    link.click();
    // é‡Šæ”¾é“¾æ¥
    link.remove();
  }

  /**
   * ç»‘å®šæ»šè½®ç¼©æ”¾äº‹ä»¶
   */
  function bindScaleEvent() {
    elements.canvasWrapper.addEventListener('wheel', (e) => {
      e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨
      // ç¼©æ”¾å¢é‡ï¼šæ»šè½®å‘ä¸Š+0.1ï¼Œå‘ä¸‹-0.1
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      const newScale = Math.max(0.5, Math.min(3, state.scale + delta)); // é™åˆ¶ç¼©æ”¾èŒƒå›´0.5-3å€
      if (newScale !== state.scale) {
        state.scale = newScale;
        applyScale();
        updateBrushCursorStyle(); // æ–°å¢ï¼šç¼©æ”¾åæ›´æ–°å…‰æ ‡
      }
    });
  }

  /**
   * åº”ç”¨ç”»å¸ƒç¼©æ”¾æ¯”ä¾‹
   */
  function applyScale() {
    elements.mainCanvas.style.transform = `scale(${state.scale})`;
    elements.tempCanvas.style.transform = `scale(${state.scale})`;
  }

  // ========== åˆå§‹åŒ– ==========
  window.addEventListener('DOMContentLoaded', initTools);
</script>
</body>
</html>