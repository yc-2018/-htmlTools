<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>PDF多功能编辑器</title>
    <!--通义编写： https://www.qianwen.com/share?shareId=0fcdd159-1f9c-4620-9fcd-588cabd19ac1-->
    <!--    <script src="https://unpkg.com/pdf-lib"></script>-->
    <!--    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>-->
    <!--这库的文档https://pdf-lib.js.org/docs/api/-->
    <script src="./pdf-lib.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #444;
        }
        input[type="file"], input[type="text"], input[type="number"], select, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            margin: 5px 10px 5px 0;
        }
        button:hover {
            background-color: #45a049;
        }
        .action-btn {
            background-color: #2196F3;
        }
        .action-btn:hover {
            background-color: #1976D2;
        }
        .delete-btn {
            background-color: #f44336;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
        }
        .info {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .example {
            font-style: italic;
            color: #666;
        }
        .operation-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .operation-item {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>PDF多功能编辑器</h1>
        
        <div class="section">
            <h3>上传主PDF文件</h3>
            <input type="file" id="mainPdfFileInput" accept=".pdf" />
            <p>当前文档页数: <span id="currentTotalPages">0</span></p>
        </div>
        
        <div class="info">
            <p><strong>功能说明：</strong></p>
            <ul>
                <li><strong>删除页面:</strong> 输入页面号，支持单页(1)、多页(1,3,5)、范围(2-5)或组合(1,3-5,7)</li>
                <li><strong>插入PDF:</strong> 在指定页面前或后插入另一个PDF的所有页面</li>
                <li><strong>插入图片:</strong> 将图片转换为PDF页面并插入到指定位置</li>
            </ul>
        </div>
        
        <div class="section">
            <h3>操作选择</h3>
            <select id="operationType">
                <option value="delete">删除页面</option>
                <option value="insertPdf">插入PDF</option>
                <option value="insertImage">插入图片</option>
            </select>
        </div>
        
        <!-- 删除页面区域 -->
        <div id="deleteSection" class="section">
            <h3>删除页面</h3>
            <label>输入要删除的页面号 (如: 1,3-5,7): </label>
            <input type="text" id="pageNumbersInput" placeholder="例如: 1,3-5,7" />
            <button class="delete-btn" onclick="deletePages()">删除页面</button>
        </div>
        
        <!-- 插入PDF区域 -->
        <div id="insertPdfSection" class="section hidden">
            <h3>插入PDF</h3>
            <div class="operation-group">
                <div class="operation-item">
                    <label>插入位置: </label>
                    <select id="insertPositionPdf">
                        <option value="before">在第几页前</option>
                        <option value="after">在第几页后</option>
                    </select>
                </div>
                <div class="operation-item">
                    <label>页面号: </label>
                    <input type="number" id="insertPageNumberPdf" min="1" value="1" />
                </div>
                <div class="operation-item">
                    <label>插入的PDF: </label>
                    <input type="file" id="insertPdfFileInput" accept=".pdf" />
                </div>
            </div>
            <button class="action-btn" onclick="insertPdf()">插入PDF</button>
        </div>
        
        <!-- 插入图片区域 -->
        <div id="insertImageSection" class="section hidden">
            <h3>插入图片</h3>
            <div class="operation-group">
                <div class="operation-item">
                    <label>插入位置: </label>
                    <select id="insertPositionImage">
                        <option value="before">在第几页前</option>
                        <option value="after">在第几页后</option>
                    </select>
                </div>
                <div class="operation-item">
                    <label>页面号: </label>
                    <input type="number" id="insertPageNumberImage" min="1" value="1" />
                </div>
                <div class="operation-item">
                    <label>插入的图片: </label>
                    <input type="file" id="insertImageFileInput" accept="image/*" />
                </div>
            </div>
            <button class="action-btn" onclick="insertImage()">插入图片</button>
        </div>
        
        <div class="section">
            <h3>PDF预览</h3>
            <iframe id="pdfPreview"></iframe>
            <br>
            <button onclick="downloadPdf()" id="downloadBtn" disabled>下载处理后的PDF</button>
            <button onclick="resetEditor()">重置编辑器</button>
        </div>
    </div>

    <script>
        let pdfDoc = null;
        let originalPdfBytes = null;

        // 初始化页面显示
        document.getElementById('operationType').addEventListener('change', function() {
            const operation = this.value;
            document.getElementById('deleteSection').classList.toggle('hidden', operation !== 'delete');
            document.getElementById('insertPdfSection').classList.toggle('hidden', operation !== 'insertPdf');
            document.getElementById('insertImageSection').classList.toggle('hidden', operation !== 'insertImage');
        });

        document.getElementById('mainPdfFileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            originalPdfBytes = await file.arrayBuffer();
            await loadAndDisplayPdf(originalPdfBytes);
        });

        async function loadAndDisplayPdf(pdfBytes) {
            try {
                pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                const totalPages = pdfDoc.getPageCount();
                document.getElementById('currentTotalPages').textContent = totalPages;
                
                // 显示PDF预览
                const previewUrl = URL.createObjectURL(new Blob([pdfBytes], { type: 'application/pdf' }));
                document.getElementById('pdfPreview').src = previewUrl;
                
                // 启用下载按钮
                document.getElementById('downloadBtn').disabled = false;
            } catch (error) {
                alert('加载PDF失败: ' + error.message);
            }
        }

        // 解析页面范围字符串，例如 "1,3-5,7" -> [1,3,4,5,7]
        function parsePageRanges(rangeStr, totalPages) {
            const pages = [];
            const ranges = rangeStr.split(',').map(r => r.trim());
            
            for (const range of ranges) {
                if (range.includes('-')) {
                    // 处理范围，如 "3-5"
                    const [start, end] = range.split('-').map(Number);
                    
                    if (isNaN(start) || isNaN(end)) {
                        throw new Error(`无效的页面范围: ${range}`);
                    }
                    
                    if (start < 1 || end > totalPages || start > end) {
                        throw new Error(`页面范围超出有效范围: ${range} (总页数: ${totalPages})`);
                    }
                    
                    for (let i = start; i <= end; i++) {
                        pages.push(i);
                    }
                } else {
                    // 处理单个页面
                    const pageNum = Number(range);
                    
                    if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
                        throw new Error(`页面号无效: ${pageNum} (总页数: ${totalPages})`);
                    }
                    
                    pages.push(pageNum);
                }
            }
            
            // 去重并排序
            return [...new Set(pages)].sort((a, b) => a - b);
        }

        async function deletePages() {
            if (!pdfDoc) {
                alert('请先上传PDF文件');
                return;
            }
            
            const pageRangeStr = document.getElementById('pageNumbersInput').value.trim();
            if (!pageRangeStr) {
                alert('请输入要删除的页面号');
                return;
            }
            
            try {
                const totalPages = pdfDoc.getPageCount();
                const pagesToDelete = parsePageRanges(pageRangeStr, totalPages);
                
                if (pagesToDelete.length === 0) {
                    alert('没有找到有效的页面号');
                    return;
                }
                
                // 验证所有页面号都在有效范围内
                for (const pageNum of pagesToDelete) {
                    if (pageNum < 1 || pageNum > totalPages) {
                        alert(`页面号 ${pageNum} 超出范围 (1-${totalPages})`);
                        return;
                    }
                }
                
                // 按降序排列页面号，这样删除时索引不会受影响
                const sortedPages = pagesToDelete.sort((a, b) => b - a);
                
                console.log(`将要删除页面: ${sortedPages.join(', ')}`);
                
                // 删除页面 (注意：pdf-lib中页面索引从0开始)
                for (const pageNum of sortedPages) {
                    pdfDoc.removePage(pageNum - 1); // 减1因为数组索引从0开始
                }
                
                // 保存并显示更新后的PDF
                const modifiedPdfBytes = await pdfDoc.save();
                await loadAndDisplayPdf(modifiedPdfBytes);
                
                alert(`成功删除页面: ${pagesToDelete.join(', ')}`);
            } catch (error) {
                alert('删除页面失败: ' + error.message);
            }
        }

        async function insertPdf() {
            if (!pdfDoc) {
                alert('请先上传主PDF文件');
                return;
            }
            
            const insertPdfFile = document.getElementById('insertPdfFileInput').files[0];
            if (!insertPdfFile) {
                alert('请选择要插入的PDF文件');
                return;
            }
            
            const position = document.getElementById('insertPositionPdf').value;
            const targetPage = parseInt(document.getElementById('insertPageNumberPdf').value);
            const totalPages = pdfDoc.getPageCount();
            
            if (isNaN(targetPage) || targetPage < 1 || targetPage > totalPages) {
                alert(`页面号无效 (1-${totalPages})`);
                return;
            }
            
            try {
                // 加载要插入的PDF
                const insertPdfBytes = await insertPdfFile.arrayBuffer();
                const insertPdfDoc = await PDFLib.PDFDocument.load(insertPdfBytes);
                
                // 计算插入位置的索引
                let insertIndex = targetPage - 1; // 转换为0基索引
                if (position === 'after') {
                    insertIndex += 1; // 在指定页后面插入
                }
                
                // 将要插入PDF的页面复制到主PDF
                const copiedPages = await pdfDoc.copyPages(insertPdfDoc, insertPdfDoc.getPageIndices());
                
                // 在指定位置插入页面
                for (let i = 0; i < copiedPages.length; i++) {
                    pdfDoc.insertPage(insertIndex + i, copiedPages[i]);
                }
                
                // 保存并显示更新后的PDF
                const modifiedPdfBytes = await pdfDoc.save();
                await loadAndDisplayPdf(modifiedPdfBytes);
                
                alert(`成功在第${targetPage}页${position === 'before' ? '前' : '后'}插入了${copiedPages.length}页PDF内容`);
            } catch (error) {
                alert('插入PDF失败: ' + error.message);
            }
        }

        async function insertImage() {
            if (!pdfDoc) {
                alert('请先上传主PDF文件');
                return;
            }
            
            const insertImageFile = document.getElementById('insertImageFileInput').files[0];
            if (!insertImageFile) {
                alert('请选择要插入的图片文件');
                return;
            }
            
            const position = document.getElementById('insertPositionImage').value;
            const targetPage = parseInt(document.getElementById('insertPageNumberImage').value);
            const totalPages = pdfDoc.getPageCount();
            
            if (isNaN(targetPage) || targetPage < 1 || targetPage > totalPages) {
                alert(`页面号无效 (1-${totalPages})`);
                return;
            }
            
            try {
                // 读取图片数据
                const imageBytes = await insertImageFile.arrayBuffer();
                
                // 创建一个新的PDF文档来存放图片
                const imagePdfDoc = await PDFLib.PDFDocument.create();
                
                // 根据图片类型嵌入到PDF
                let embeddedImage;
                if (insertImageFile.type.startsWith('image/jpeg')) {
                    embeddedImage = await imagePdfDoc.embedJpg(imageBytes);
                } else if (insertImageFile.type.startsWith('image/png')) {
                    embeddedImage = await imagePdfDoc.embedPng(imageBytes);
                } else {
                    alert('仅支持JPG和PNG格式的图片');
                    return;
                }
                
                // 添加一个页面用于放置图片
                const imagePage = imagePdfDoc.addPage();
                const { width, height } = embeddedImage.scale(1);
                
                // 设置页面尺寸为图片尺寸或A4比例
                const maxWidth = 500;
                const maxHeight = 700;
                let scale = Math.min(maxWidth / width, maxHeight / height, 1);
                
                const scaledWidth = width * scale;
                const scaledHeight = height * scale;
                
                imagePage.setSize(scaledWidth, scaledHeight);
                imagePage.drawImage(embeddedImage, {
                    x: (scaledWidth - width * scale) / 2,
                    y: (scaledHeight - height * scale) / 2,
                    width: width * scale,
                    height: height * scale,
                });
                
                // 保存图片PDF
                const imagePdfBytes = await imagePdfDoc.save();
                const imagePdfDocLoaded = await PDFLib.PDFDocument.load(imagePdfBytes);
                
                // 计算插入位置的索引
                let insertIndex = targetPage - 1; // 转换为0基索引
                if (position === 'after') {
                    insertIndex += 1; // 在指定页后面插入
                }
                
                // 将图片PDF的页面复制到主PDF
                const copiedPages = await pdfDoc.copyPages(imagePdfDocLoaded, imagePdfDocLoaded.getPageIndices());
                
                // 在指定位置插入页面
                for (let i = 0; i < copiedPages.length; i++) {
                    pdfDoc.insertPage(insertIndex + i, copiedPages[i]);
                }
                
                // 保存并显示更新后的PDF
                const modifiedPdfBytes = await pdfDoc.save();
                await loadAndDisplayPdf(modifiedPdfBytes);
                
                alert(`成功在第${targetPage}页${position === 'before' ? '前' : '后'}插入了图片`);
            } catch (error) {
                alert('插入图片失败: ' + error.message);
            }
        }

        function downloadPdf() {
            if (!pdfDoc) {
                alert('没有可下载的PDF');
                return;
            }
            
            pdfDoc.save().then(pdfBytes => {
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'edited-pdf.pdf';
                document.body.appendChild(a);
                a.click();
                
                // 清理DOM元素和URL对象
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }).catch(error => {
                alert('下载失败: ' + error.message);
            });
        }

        function resetEditor() {
            // 重置所有输入字段
            document.getElementById('mainPdfFileInput').value = '';
            document.getElementById('pageNumbersInput').value = '';
            document.getElementById('insertPageNumberPdf').value = '1';
            document.getElementById('insertPdfFileInput').value = '';
            document.getElementById('insertPageNumberImage').value = '1';
            document.getElementById('insertImageFileInput').value = '';
            
            // 重置状态
            pdfDoc = null;
            originalPdfBytes = null;
            document.getElementById('currentTotalPages').textContent = '0';
            document.getElementById('pdfPreview').src = '';
            document.getElementById('downloadBtn').disabled = true;
        }
    </script>
</body>
</html>



