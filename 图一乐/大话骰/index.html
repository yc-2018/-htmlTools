<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>å¤§è¯éª°</title>
  <link rel="stylesheet" href="index.css">

</head>
<body>

<div class="dice-main" id="diceMain">
  <div class="dice-cover" id="diceCover" style="transform:translateY(-80%)" onclick="handleCover()"></div>

  <div class="dices" id="dices"></div>

  <div class="dice-base"></div>

</div>

<div style="display: grid;grid-template-columns: repeat(2, 1fr); gap: 10px;margin-bottom: 20px;">
  <button class="btn openCloseBg" id="openCoverB" onclick="handleCover()">å…³ç›…</button>
  <button class="btn" id="shakeDiceB" onclick="shakeDice()">æ‘‡éª°å­ğŸ²</button>
  <button class="btn" onclick="calculate()">ç»“æœ(å¼€)</button>
  <button class="btn prohibitBg" onclick="doNotRollDice(this)">ç¦æ­¢æ‘‡éª°ğŸš«</button>
</div>

<div id="result"></div>
<div id="resultSpecial"></div>

<!-- ä¸€äº›æ— è¶³è½»é‡çš„æŒ‰é’® -->
<div style="margin-top: 10px">
  <div>
    <label for="openMp3Check">å¼€ç›…æ¨æˆ¬éŸ³æ•ˆ</label>
    <input type="checkbox" id="openMp3Check" checked/>
  </div>

  <div>
    <label for="semiTransparent">éª°ç›…åŠé€æ˜</label>
    <input type="checkbox" id="semiTransparent" onclick="handleTransparency(this)"/>
  </div>

  <div>
    <label for="noAutoCover">æ‘‡éª°å­ä¸è‡ªåŠ¨ç›–ç›…</label>
    <input type="checkbox" id="noAutoCover"/>
  </div>

  <div>
    <a href="./dice-rules.html">åŸºæœ¬è¯´æ˜</a>
  </div>
</div>


</body>

<script>
  // æå‰åŠ è½½éŸ³æ•ˆ
  const openMp3 = new Audio('./open.mp3');
  const diceMp3 = new Audio('./dice.mp3');
  let isCoverOpen = true;     // éª°ç›…å¼€å…³çŠ¶æ€
  let isNotRollDice = false;  // æ˜¯å¦ç¦æ­¢æ‘‡éª°å­

  const diceMain = document.getElementById('diceMain')            // éª°å­å…¨éƒ¨
  const diceCover = document.getElementById('diceCover')          // éª°ç›…
  const dices = document.getElementById('dices')                  // éª°å­å®¹å™¨
  const openCoverB = document.getElementById('openCoverB')        // éª°ç›…å¼€å…³æŒ‰é’®
  const shakeDiceB = document.getElementById('shakeDiceB')        // æ‘‡éª°å­æŒ‰é’®
  const result = document.getElementById('result')                // å¼€çš„ç»“æœ
  const resultSpecial = document.getElementById('resultSpecial')  // å¼€çš„ç»“æœ(ç‰¹æ®Š
  const playOpenMp3 = document.getElementById('openMp3Check');    // å‹¾é€‰ æ˜¯å¦æ’­æ”¾å¼€éª°ç›…éŸ³æ•ˆ(æ¨æˆ¬å¤§å«:å¼€!!!
  const noAutoCover = document.getElementById('noAutoCover');     // å‹¾é€‰ æ˜¯å¦è‡ªåŠ¨ç›–ç›–å­

  shakeDice(true) // åˆå§‹åŒ–éª°å­

  /**
   * æ‘‡éª°å­é€»è¾‘
   * @param {boolean} isInit æ˜¯å¦æ˜¯åˆå§‹åŒ–
   *
   * @author ğ“’ğ“±ğ“®ğ“·ğ“–ğ“¾ğ“ªğ“·ğ“°ğ“›ğ“¸ğ“·ğ“°
   * @since 2025/9/15 2:42
   */
  function shakeDice(isInit = false) {
    let diceNumbers = Array(5).fill(0)
    if (!isInit) {
      shakeDiceB.disabled = true          // ç¦ç”¨æŒ‰é’®
      if (!noAutoCover.checked) handleCover(isCoverOpen = true)     // å…³é—­éª°ç›…
      diceMain.classList.add('shaking');  // æ·»åŠ æ‘‡åŠ¨åŠ¨ç”»
      diceMp3.play()                      // æ’­æ”¾éª°å­éŸ³æ•ˆ
      diceNumbers = diceNumbers.map(() => Math.floor(Math.random() * 6) + 1).sort()
      result.innerHTML = '';
      resultSpecial.innerHTML = '';
    }

    window.setTimeout(() => {
      dices.innerHTML = '';
      diceNumbers.forEach(diceNumber => {
        const dice = document.createElement('img')
        dice.src = `./dice-svg/${diceNumber}.svg`
        dices.appendChild(dice)
        shakeDiceB.disabled = false
      })
    }, 200)

    // 2ç§’ååœæ­¢æ‘‡åŠ¨
    setTimeout(() => {
      diceMain.classList.remove('shaking');
    }, 1000);

  }

  /**
   * å¤„ç†éª°ç›…å¼€å…³
   *
   * @author ğ“’ğ“±ğ“®ğ“·ğ“–ğ“¾ğ“ªğ“·ğ“°ğ“›ğ“¸ğ“·ğ“°
   * @since 2025/9/15 2:58
   */
  function handleCover() {
    if (isCoverOpen) {
      openCoverB.innerText = 'æ‰“å¼€ç›…'
      diceCover.style.transform = 'translateY(0)'
    } else {
      diceCover.style.transform = 'translateY(-80%)'
      openCoverB.innerText = 'å…³ç›…'
    }
    isCoverOpen = !isCoverOpen
  }

  /**
   * è®¡ç®—é€»è¾‘
   *
   * @author ğ“’ğ“±ğ“®ğ“·ğ“–ğ“¾ğ“ªğ“·ğ“°ğ“›ğ“¸ğ“·ğ“°
   * @since 2025/9/15 2:58
   */
  function calculate() {
    if (playOpenMp3.checked) openMp3.play()
    handleCover(isCoverOpen = false)
    const resultCountMap = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0}

    // æ‹¿åˆ°å…¨éƒ¨æ•°å­—(ä»urlé‡Œé¢åˆ‡å‰²å‡ºæ¥
    dices.querySelectorAll('img').forEach(dice => {
      const diceNumber = Number(dice.src.match(/\/dice-svg\/(\d+)\.svg/)[1])
      resultCountMap[diceNumber]++
    })

    delete resultCountMap[0]; // åˆ é™¤ 0 çš„ksy

    const entries = Object.entries(resultCountMap);
    const oneNumber = resultCountMap[1];

    // æ£€æŸ¥æ˜¯å¦æ²¡æ‘‡ï¼ˆå…¨æ˜¯0)
    if (entries.every(([_key, value]) => value === 0)) {
      return resultSpecial.innerHTML = `å…ˆæ‘‡å•¦~`
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯çº¯è±¹  è±¹å­åˆå«å›´éª°
    const findPureLeopard = entries.find(([_key, value]) => value === 5);
    if (findPureLeopard) {
      return resultSpecial.innerHTML = `ğŸ†çº¯è±¹<img src="./dice-svg/${findPureLeopard[0]}.svg" alt=""/>5+2ä¸ª`
    }
    // æ£€æŸ¥æ˜¯å¦æ˜¯è±¹å­
    if (resultCountMap[1] !== 0) {  // é¦–å…ˆï¼ŒæŠ¥çº¸çš„æ¦‚å¿µä¸€è‚¯å®šä¸èƒ½ä¸ºé›¶[æ¡ä»¶å¯å¿½ç•¥
      const findLeopard = entries.find(([key, value]) => {
        if (key === "1") return false;  // å½“ç„¶ä¸å¯ä»¥ä¸º1   æ¡ä»¶å¯å¿½ç•¥ï¼š1åŠ æœ¬èº«åªèƒ½æ˜¯å¶æ•°ï¼Œä¸å¯èƒ½ç­‰äºäº”
        return value + oneNumber === 5
      });
      if (findLeopard) {
        return resultSpecial.innerHTML = `ğŸ†è±¹å­<img src="./dice-svg/${findLeopard[0]}.svg" alt=""/>(${findLeopard[1]}+${oneNumber})+1ä¸ª`
      }
    }
    // æ£€æŸ¥æ˜¯å¦æ˜¯é¡ºå­(é¡ºå­ï¼Œå°±æ˜¯5é¢—éª°å­ï¼Œæ²¡æœ‰ç›¸åŒçš„ï¼Œå°±æ˜¯é¡ºå­:::å°±æ˜¯åˆ—è¡¨çš„valueå…¨éƒ¨è¦<=1)
    if (entries.every(([_key, value]) => value <= 1)) {
      return resultSpecial.innerHTML = `é¡ºéª°(é‡æ‘‡æˆ–å½’0)`
    }

    /** è®¡ç®—æœ‰1çš„ç‰¹æ®Šæƒ…å†µï¼Œç»™çš„æ ·å¼ */
    const addOneNumber = (iKey) => {
      if (oneNumber === 0 || iKey === 1) return resultCountMap[iKey]
      let keyNun = resultCountMap[iKey] === 0 ? '' : `<b>${resultCountMap[iKey]}</b><span style="color: #4bafab">+</span>`
      return `${keyNun}<span style="color: red">${oneNumber}</span>`
    }

    // è¾“å‡ºé0ä¸ªçš„ç»“æœ
    let resultText = '';
    for (let i = 1; i <= 6; i++) {
      if (resultCountMap[i] > 0 || oneNumber > 0) {
        resultText += `
          <div>
            <img src="./dice-svg/${i}.svg" alt=""/>
            <div>${addOneNumber(i)}</div>
          </div>`;
      }
    }
    if (oneNumber > 0) result.style.gridTemplateColumns='repeat(6, 1fr)'
    else result.style.gridTemplateColumns = `repeat(${entries.filter(([_, value]) => value > 0).length}, 1fr)`
    result.innerHTML = resultText;
  }

  /**
   * ç¦æ­¢æ‘‡éª°å­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
   *
   * @author ğ“’ğ“±ğ“®ğ“·ğ“–ğ“¾ğ“ªğ“·ğ“°ğ“›ğ“¸ğ“·ğ“°
   * @since 2025/9/15 2:58
   */
  function doNotRollDice(e) {
    if (isNotRollDice) {
      isNotRollDice = false;
      shakeDiceB.classList.remove('prohibit');
      e.innerText = 'ç¦æ­¢æ‘‡éª°ğŸš«'

    } else {
      isNotRollDice = true;
      shakeDiceB.classList.add('prohibit');
      e.innerText = 'å…è®¸æ‘‡éª°â­•'
    }
  }

  /**
   * éª°ç›…åŠé€æ˜
   *
   * @author ğ“’ğ“±ğ“®ğ“·ğ“–ğ“¾ğ“ªğ“·ğ“°ğ“›ğ“¸ğ“·ğ“°
   * @since 2025/9/15 22:03
   */
  function handleTransparency(checkbox) {
    if (checkbox.checked) diceCover.style.background = 'radial-gradient(#ffffffad 0%, #000000d4 100%)';
    else diceCover.style.background = 'radial-gradient(#fff 0%, #000 100%)';
  }

</script>
</html>